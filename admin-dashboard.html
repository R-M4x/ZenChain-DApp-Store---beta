<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenChain Store</title>
    <style>
        :root {
            --primary-green: #00FF88;
            --secondary-cyan: #00CCDD;
            --tertiary-lime: #88FF44;
            --accent-yellow: #CCFF66;
            --zen-gradient: linear-gradient(135deg, #CCFF66, #0cda7a, #00CCDD);
            --background-dark: #0D1F1A;
            --surface-green: #1A2E26;
            --surface-light: #243530;
            --surface-hover: #2F4138;
            --text-light: #E8FFF3;
            --text-secondary: #B8E6D1;
            --text-muted: #8FA89D;
            --border-green: rgba(0, 255, 136, 0.3);
            --border-cyan: rgba(0, 204, 221, 0.3);
            --glow-green: 0 0 20px rgba(0, 255, 136, 0.4);
            --error-red: #ff4757;
            --warning-orange: #ffa502;
            --success-green: #2ed573;
            --info-blue: #70a1ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background-dark);
            color: var(--text-light);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header */
        .header {
            background: var(--surface-light);
            border-bottom: 2px solid var(--border-green);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: var(--zen-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .header-title {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(90deg, #CCFF66, #00FF88, #00CCDD);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: -0.2rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .wallet-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--surface-green);
            border: 1px solid var(--border-green);
            border-radius: 12px;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--error-red);
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--success-green);
        }

        .wallet-info {
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: var(--primary-green);
            font-weight: 600;
        }

        .wallet-balance {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .connect-wallet-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--zen-gradient);
            color: var(--background-dark);
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .connect-wallet-btn:hover {
            box-shadow: var(--glow-green);
            transform: translateY(-2px);
        }

        .quick-links {
            display: flex;
            gap: 0.5rem;
        }

        .quick-link {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid var(--border-cyan);
            border-radius: 8px;
            color: var(--secondary-cyan);
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .quick-link:hover {
            background: rgba(0, 204, 221, 0.1);
            transform: translateY(-1px);
        }

        /* Stats Bar - FIXED to prevent overflow */
        .stats-bar {
            background: var(--surface-green);
            border-bottom: 1px solid var(--border-green);
            padding: 1rem 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
        }

        .stat-card {
            background: var(--surface-light);
            border: 1px solid var(--border-green);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary-green);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--zen-gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
            line-height: 1.2;
        }

        /* Main Dashboard - FIXED LAYOUT (2 columns max) */
        .main-dashboard {
            padding: 2rem 0;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* FIXED: Only 2 columns */
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .dashboard-card {
            background: var(--surface-green);
            border: 1px solid var(--border-green);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 255, 136, 0.15);
        }

        .card-header {
            background: var(--surface-light);
            padding: 1.25rem;
            border-bottom: 2px solid var(--border-green);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            background: var(--zen-gradient);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--background-dark);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-light);
            flex: 1;
        }

        .card-body {
            padding: 1.5rem;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .dashboard-btn {
            padding: 0.75rem 1rem;
            background: var(--surface-light);
            border: 1px solid var(--border-green);
            border-radius: 10px;
            color: var(--text-light);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            text-align: center;
        }

        .dashboard-btn:hover {
            background: var(--surface-hover);
            border-color: var(--primary-green);
            transform: translateY(-2px);
        }

        .dashboard-btn.primary {
            background: var(--zen-gradient);
            color: var(--background-dark);
            border-color: transparent;
        }

        .dashboard-btn.danger {
            background: var(--error-red);
            border-color: var(--error-red);
            color: white;
        }

        .dashboard-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .output-panel {
            background: var(--surface-light);
            border: 1px solid var(--border-cyan);
            border-radius: 12px;
            padding: 1rem;
            max-height: 350px; /* INCREASED HEIGHT */
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .output-panel::-webkit-scrollbar {
            width: 6px;
        }

        .output-panel::-webkit-scrollbar-track {
            background: var(--surface-green);
            border-radius: 3px;
        }

        .output-panel::-webkit-scrollbar-thumb {
            background: var(--border-green);
            border-radius: 3px;
        }

        /* Status Messages */
        .status-message {
            padding: 1rem;
            border-radius: 10px;
            margin: 0.5rem 0;
            border-left: 4px solid;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .status-message.success {
            background: rgba(46, 213, 115, 0.1);
            border-left-color: var(--success-green);
            color: var(--success-green);
        }

        .status-message.error {
            background: rgba(255, 71, 87, 0.1);
            border-left-color: var(--error-red);
            color: var(--error-red);
        }

        .status-message.warning {
            background: rgba(255, 165, 2, 0.1);
            border-left-color: var(--warning-orange);
            color: var(--warning-orange);
        }

        .status-message.info {
            background: rgba(112, 161, 255, 0.1);
            border-left-color: var(--info-blue);
            color: var(--info-blue);
        }

        /* Purchase Items */
        .purchase-item {
            background: var(--surface-green);
            border: 1px solid var(--border-green);
            border-left: 4px solid var(--primary-green);
            border-radius: 8px;
            padding: 1rem;
            margin: 0.75rem 0;
            transition: all 0.3s ease;
        }

        .purchase-item:hover {
            border-left-color: var(--secondary-cyan);
            background: var(--surface-hover);
        }

        .purchase-item.new {
            border-left-color: var(--accent-yellow);
            animation: highlight 2s ease-out;
        }

        .purchase-header {
            font-weight: 700;
            color: var(--primary-green);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .purchase-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            font-size: 0.8rem;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .detail-icon {
            font-size: 0.9rem;
        }

        .tx-link {
            color: var(--secondary-cyan);
            text-decoration: none;
        }

        .tx-link:hover {
            text-decoration: underline;
        }

        /* Product Management */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1rem;
            max-height: 350px;
            overflow-y: auto;
        }

        .product-item {
            background: var(--surface-light);
            border: 1px solid var(--border-green);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.3s ease;
        }

        .product-item:hover {
            transform: translateY(-2px);
            border-color: var(--primary-green);
        }

        .product-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .product-emoji {
            font-size: 1.5rem;
        }

        .product-id {
            background: var(--zen-gradient);
            color: var(--background-dark);
            padding: 0.2rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .product-name {
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
            line-height: 1.3;
        }

        .product-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }

        .product-price {
            background: linear-gradient(90deg, #CCFF66, #00FF88);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 600;
        }

        .product-stock {
            font-weight: 500;
        }

        .stock-low {
            color: var(--warning-orange);
        }

        .stock-out {
            color: var(--error-red);
        }

        .product-actions {
            display: flex;
            gap: 0.5rem;
        }

        .product-btn {
            flex: 1;
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border-green);
            border-radius: 6px;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s ease;
        }

        .product-btn:hover {
            background: var(--surface-hover);
            border-color: var(--primary-green);
        }

        .product-btn.danger {
            border-color: var(--error-red);
            color: var(--error-red);
        }

        .product-btn.danger:hover {
            background: rgba(255, 71, 87, 0.1);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            background: var(--surface-light);
            border: 1px solid var(--border-green);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.2);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--surface-green);
            border: 2px solid var(--border-green);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-green);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            color: var(--error-red);
            background: rgba(255, 71, 87, 0.1);
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes highlight {
            0% { background: rgba(204, 255, 102, 0.2); }
            100% { background: transparent; }
        }

        /* Responsive Design - IMPROVED */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 968px) {
            .dashboard-grid {
                grid-template-columns: 1fr; /* Stack cards on smaller screens */
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }

            .header-actions {
                justify-content: center;
            }

            .button-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .product-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-card {
                margin: 0 -0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <img src="/media/icons/zenchain-icon.png" alt="ZenChain Logo" class="logo-image">
                    <div>
                        <h1 class="header-title">ZenChain Admin Dashboard</h1>
                        <p class="header-subtitle">Store Management System</p>
                    </div>
                </div>

                <div class="header-actions">
                    <div class="wallet-status" id="wallet-status">
                        <div class="status-dot" id="status-dot"></div>
                        <div class="wallet-info">
                            <div class="wallet-address" id="wallet-display">Not Connected</div>
                            <div class="wallet-balance" id="balance-display">Connect wallet</div>
                        </div>
                    </div>

                    <button class="connect-wallet-btn" id="wallet-action">
                        <span>üîó</span>
                        <span id="wallet-action-text">Connect Wallet</span>
                    </button>

                    <div class="quick-links">
                        <a href="https://zentrace.io/address/0xBc3A065e47499227A1596CC64c7f417536654a82" target="_blank" class="quick-link">
                            üîç Explorer
                        </a>
                        <a href="https://faucet.zenchain.io" target="_blank" class="quick-link">
                            üíß Faucet
                        </a>
                        <a href="zenchain-store-complete.html" target="_blank" class="quick-link">
                            üõí Store
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Stats Bar -->
    <section class="stats-bar">
        <div class="container">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-purchases">-</div>
                    <div class="stat-label">Total Purchases</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-revenue">-</div>
                    <div class="stat-label">Revenue (ZTC)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="unique-customers">-</div>
                    <div class="stat-label">Unique Customers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-products">12</div>
                    <div class="stat-label">Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="low-stock-count">1</div>
                    <div class="stat-label">Low Stock Items</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Dashboard -->
    <main class="main-dashboard">
        <div class="container">
            <div class="dashboard-grid">
                <!-- Purchase Monitoring -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-icon">üìä</div>
                        <h2 class="card-title">Purchase Monitoring</h2>
                    </div>
                    <div class="card-body">
                        <div class="button-grid">
                            <button class="dashboard-btn primary" onclick="loadRecentPurchases()">Recent Purchases</button>
                            <button class="dashboard-btn" onclick="loadPurchasesFromBlock()">From Block</button>
                            <button class="dashboard-btn" onclick="startLiveMonitoring()" id="live-btn">Start Live</button>
                            <button class="dashboard-btn" onclick="checkContractStatus()">Contract Status</button>
                        </div>
                        <div class="output-panel" id="purchases-output">
                            Click "Recent Purchases" to load transaction history...
                        </div>
                    </div>
                </div>

                <!-- Financial Overview -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-icon">üí∞</div>
                        <h2 class="card-title">Financial Overview</h2>
                    </div>
                    <div class="card-body">
                        <div class="button-grid">
                            <button class="dashboard-btn primary" onclick="checkAdminBalance()">Admin Balance</button>
                            <button class="dashboard-btn" onclick="checkContractBalance()">Contract Balance</button>
                            <button class="dashboard-btn" onclick="withdrawFunds()">Withdraw Funds</button>
                            <button class="dashboard-btn" onclick="getNetworkInfo()">Network Info</button>
                        </div>
                        <div class="output-panel" id="financial-output">
                            Financial data will appear here...
                        </div>
                    </div>
                </div>

                <!-- Inventory Management -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-icon">üì¶</div>
                        <h2 class="card-title">Inventory Management</h2>
                    </div>
                    <div class="card-body">
                        <div class="button-grid">
                            <button class="dashboard-btn primary" onclick="viewAllProducts()">View Products</button>
                            <button class="dashboard-btn" onclick="showAddProductModal()">Add Product</button>
                            <button class="dashboard-btn" onclick="showStockManager()">Manage Stock</button>
                            <button class="dashboard-btn danger" onclick="showDeleteProductModal()">Delete Product</button>
                        </div>
                        <div class="output-panel" id="inventory-output">
                            Click "View Products" to see inventory...
                        </div>
                    </div>
                </div>

                <!-- System Analytics -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-icon">üìà</div>
                        <h2 class="card-title">Transaction Debug Tools</h2>
                    </div>
                    <div class="card-body">
                        <div class="button-grid">
                            <button class="dashboard-btn primary" onclick="debugLastTransaction()">Debug Last TX</button>
                            <button class="dashboard-btn" onclick="checkGasSettings()">Check Gas</button>
                            <button class="dashboard-btn" onclick="validateContract()">Validate Contract</button>
                            <button class="dashboard-btn" onclick="exportErrorLogs()">Export Errors</button>
                        </div>
                        <div class="output-panel" id="analytics-output">
                            Transaction debugging tools will appear here...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Product Modal -->
    <div class="modal" id="add-product-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Product</h3>
                <button class="modal-close" onclick="closeModal('add-product-modal')">&times;</button>
            </div>
            <form id="add-product-form">
                <div class="form-group">
                    <label class="form-label">Product Name</label>
                    <input type="text" class="form-input" id="product-name" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Price (ZTC)</label>
                        <input type="number" class="form-input" id="product-price" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stock Quantity</label>
                        <input type="number" class="form-input" id="product-stock" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="product-category" required>
                            <option value="">Select Category</option>
                            <option value="digital">Digital</option>
                            <option value="nft">NFT</option>
                            <option value="gaming">Gaming</option>
                            <option value="apparel">Apparel</option>
                            <option value="accessories">Accessories</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Emoji/Icon</label>
                        <input type="text" class="form-input" id="product-emoji" placeholder="üì¶">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="product-description" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Delivery Type</label>
                        <select class="form-select" id="product-delivery">
                            <option value="Instant">Instant</option>
                            <option value="1-2 days">1-2 days</option>
                            <option value="3-5 days">3-5 days</option>
                            <option value="1-2 weeks">1-2 weeks</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Badge (Optional)</label>
                        <input type="text" class="form-input" id="product-badge" placeholder="Popular, Limited, etc.">
                    </div>
                </div>
                <div class="button-grid">
                    <button type="button" class="dashboard-btn" onclick="closeModal('add-product-modal')">Cancel</button>
                    <button type="submit" class="dashboard-btn primary">Add Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Stock Manager Modal -->
    <div class="modal" id="stock-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Manage Stock</h3>
                <button class="modal-close" onclick="closeModal('stock-modal')">&times;</button>
            </div>
            <div id="stock-manager-content">
                Loading products...
            </div>
        </div>
    </div>

    <!-- Delete Product Modal -->
    <div class="modal" id="delete-product-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Delete Product</h3>
                <button class="modal-close" onclick="closeModal('delete-product-modal')">&times;</button>
            </div>
            <div id="delete-manager-content">
                Loading products...
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.0/dist/ethers.umd.min.js"></script>

    <script>
        console.log('üöÄ ZenChain Admin Dashboard');

        // Contract Configuration
        const CONTRACT_ADDRESS = '0xBc3A065e47499227A1596CC64c7f417536654a82';
        const CONTRACT_ABI = [
            "function owner() external view returns (address)",
            "function getActiveProducts() external view returns (tuple(uint256 id, string name, uint256 price, uint256 stock, bool active, string category, string metadataURI)[])",
            "function getUserPurchases(address _user) external view returns (uint256[])",
            "function getPurchase(uint256 _purchaseId) external view returns (tuple(uint256 productId, address buyer, uint256 quantity, uint256 totalPrice, uint256 timestamp))",
            "function addProduct(string memory _name, uint256 _price, uint256 _stock, string memory _category, string memory _metadataURI) external",
            "function updateStock(uint256 _productId, uint256 _newStock) external",
            "function withdrawZTC() external",
            "event ProductPurchased(uint256 indexed purchaseId, uint256 indexed productId, address indexed buyer, uint256 quantity, uint256 totalPrice)"
        ];

        // RPC Configuration
        const RPC_ENDPOINTS = [
            'https://zenchain-testnet.api.onfinality.io/public',
            'wss://zenchain-testnet.api.onfinality.io/public-ws'
        ];

        const ZENCHAIN_CONFIG = {
            chainId: 8408,
            chainIdHex: '0x20D8',
            chainName: 'ZenChain Testnet',
            nativeCurrency: { name: 'ZenChain Token', symbol: 'ZTC', decimals: 18 },
            rpcUrls: RPC_ENDPOINTS,
            blockExplorerUrls: ['https://zentrace.io']
        };

        // Global State
        let provider;
        let contract;
        let signer;
        let isMonitoring = false;
        let currentBlockNumber = 0;
        let walletConnected = false;
        let userAddress = null;
        let currentRpcIndex = 0;

        async function init() {
            console.log('üîß Initializing Admin Dashboard...');

            if (typeof ethers === 'undefined') {
                showStatus('‚ùå Ethers.js not loaded', 'error');
                return;
            }

            try {
                // Try different RPC endpoints until one works
                provider = await connectToValidRPC();

                if (!provider) {
                    throw new Error('All RPC endpoints failed');
                }

                // Create read-only contract instance
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                currentBlockNumber = await provider.getBlockNumber();

                updateStatus('‚úÖ Connected to ZenChain Testnet', 'success', 'purchases-output');

                // Try to connect wallet if available
                if (window.ethereum) {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        await connectWallet();
                    }
                }

                // Load initial data
                await updateAllStats();
                checkContractStatus();

            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
                updateStatus('‚ùå Failed to connect: ' + error.message, 'error', 'purchases-output');
                showTransactionTroubleshooting();
            }
        }

        // RPC CONNECTION with retry logic
        async function connectToValidRPC() {
            for (let i = 0; i < RPC_ENDPOINTS.length; i++) {
                const rpc = RPC_ENDPOINTS[i];
                try {
                    console.log('üîó Trying RPC:', rpc);

                    const testProvider = new ethers.JsonRpcProvider(rpc, {
                        chainId: 8408,
                        name: 'zenchain-testnet'
                    });

                    // Test with timeout
                    const blockNumberPromise = testProvider.getBlockNumber();
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('RPC timeout')), 10000)
                    );

                    await Promise.race([blockNumberPromise, timeoutPromise]);

                    currentRpcIndex = i;
                    console.log('‚úÖ Connected to RPC:', rpc);
                    return testProvider;

                } catch (error) {
                    console.log(`‚ùå Failed RPC ${rpc}:`, error.message);
                    continue;
                }
            }
            return null;
        }

        // Show troubleshooting info for failed transactions
        function showTransactionTroubleshooting() {
            const html = `
                <div class="status-message warning">
                    <strong>üîß Transaction Troubleshooting</strong><br><br>
                    Based on ZenChain explorer showing failed transactions, here are likely causes:<br><br>

                    <strong>1. RPC Network Issues:</strong><br>
                    ‚Ä¢ ZenChain testnet has unstable RPC performance<br>
                    ‚Ä¢ Try different RPC endpoints<br>
                    ‚Ä¢ Wait and retry during less busy times<br><br>

                    <strong>2. Gas Limit Issues:</strong><br>
                    ‚Ä¢ Transactions may need higher gas limits<br>
                    ‚Ä¢ ZenChain testnet gas estimation can be inaccurate<br><br>

                    <strong>3. Contract State Issues:</strong><br>
                    ‚Ä¢ Product IDs might not exist in the contract<br>
                    ‚Ä¢ Stock levels might be different than expected<br>
                    ‚Ä¢ Contract functions may have changed<br><br>

                    üí° <strong>Recommended Actions:</strong><br>
                    ‚Ä¢ Use "Debug Last TX" to analyze failures<br>
                    ‚Ä¢ Check "Network Info" for current status<br>
                    ‚Ä¢ Try transactions during off-peak hours<br>
                    ‚Ä¢ Consider updating contract if needed
                </div>
            `;
            updateStatus(html, '', 'analytics-output');
        }

        // DEBUG FUNCTIONS for transaction failures
        async function debugLastTransaction() {
            if (!walletConnected) {
                updateStatus('‚ö†Ô∏è Connect wallet to debug transactions', 'warning', 'analytics-output');
                return;
            }

            try {
                updateStatus('üîç Analyzing last transaction...', 'info', 'analytics-output');

                // Get recent transactions for the connected wallet
                const latestBlock = await provider.getBlockNumber();
                const startBlock = Math.max(latestBlock - 100, 0);

                // simplified debug systrm
                const html = `
                    <div class="status-message info">
                        <strong>üîç Transaction Debug Analysis</strong><br><br>

                        <strong>Current Network Status:</strong><br>
                        ‚Ä¢ RPC Endpoint: ${RPC_ENDPOINTS[currentRpcIndex]}<br>
                        ‚Ä¢ Latest Block: ${latestBlock}<br>
                        ‚Ä¢ Scanning Range: ${startBlock} - ${latestBlock}<br><br>

                        <strong>Common ZenChain Issues:</strong><br>
                        ‚Ä¢ Gas estimation failures<br>
                        ‚Ä¢ RPC timeout issues<br>
                        ‚Ä¢ Contract state synchronization<br>
                        ‚Ä¢ Network congestion during peak times<br><br>

                        <strong>Recommended Solutions:</strong><br>
                        ‚Ä¢ Increase gas limit to 500,000+<br>
                        ‚Ä¢ Add retry logic with delays<br>
                        ‚Ä¢ Use static gas price (50 Gwei)<br>
                        ‚Ä¢ Wait 30+ seconds between transactions
                    </div>
                `;
                updateStatus(html, '', 'analytics-output');

            } catch (error) {
                updateStatus('‚ùå Debug analysis failed: ' + error.message, 'error', 'analytics-output');
            }
        }

        async function checkGasSettings() {
            try {
                updateStatus('‚õΩ Checking gas settings...', 'info', 'analytics-output');

                const gasPrice = await provider.getFeeData();
                const block = await provider.getBlock('latest');

                const html = `
                    <div class="status-message info">
                        <strong>‚õΩ Gas Analysis</strong><br><br>

                        <strong>Current Network Gas:</strong><br>
                        ‚Ä¢ Gas Price: ${gasPrice.gasPrice ? ethers.formatUnits(gasPrice.gasPrice, 'gwei') : 'N/A'} Gwei<br>
                        ‚Ä¢ Max Fee: ${gasPrice.maxFeePerGas ? ethers.formatUnits(gasPrice.maxFeePerGas, 'gwei') : 'N/A'} Gwei<br>
                        ‚Ä¢ Block Gas Limit: ${block.gasLimit.toString()}<br>
                        ‚Ä¢ Block Gas Used: ${block.gasUsed.toString()}<br><br>

                        <strong>Recommended Settings for ZenChain:</strong><br>
                        ‚Ä¢ Gas Limit: 500,000 - 1,000,000<br>
                        ‚Ä¢ Gas Price: 50-100 Gwei<br>
                        ‚Ä¢ Timeout: 120 seconds<br><br>

                        <strong>Common Issues:</strong><br>
                        ‚Ä¢ ZenChain gas estimation is unreliable<br>
                        ‚Ä¢ Use manual gas settings<br>
                        ‚Ä¢ Increase limits for complex transactions
                    </div>
                `;
                updateStatus(html, '', 'analytics-output');

            } catch (error) {
                updateStatus('‚ùå Gas check failed: ' + error.message, 'error', 'analytics-output');
            }
        }

        async function validateContract() {
            try {
                updateStatus('üîç Validating contract...', 'info', 'analytics-output');

                // Check if contract exists and has code
                const code = await provider.getCode(CONTRACT_ADDRESS);
                const balance = await provider.getBalance(CONTRACT_ADDRESS);

                let validationResults = [];

                if (code === '0x') {
                    validationResults.push('‚ùå No contract code at this address');
                } else {
                    validationResults.push(`‚úÖ Contract exists (${(code.length / 2 - 1).toLocaleString()} bytes)`);
                }

                // Try to call a simple read function
                try {
                    const owner = await contract.owner();
                    validationResults.push(`‚úÖ Owner function works: ${owner.substring(0, 10)}...`);
                } catch (error) {
                    validationResults.push(`‚ùå Owner function failed: ${error.message}`);
                }

                // Try to get active products
                try {
                    const products = await contract.getActiveProducts();
                    validationResults.push(`‚úÖ getActiveProducts works: ${products.length} products`);
                } catch (error) {
                    validationResults.push(`‚ùå getActiveProducts failed: ${error.message}`);
                }

                const html = `
                    <div class="status-message ${code === '0x' ? 'error' : 'success'}">
                        <strong>üîç Contract Validation Results</strong><br><br>

                        <strong>Contract Status:</strong><br>
                        ${validationResults.join('<br>')}<br><br>

                        <strong>Contract Details:</strong><br>
                        ‚Ä¢ Address: ${CONTRACT_ADDRESS}<br>
                        ‚Ä¢ Balance: ${ethers.formatEther(balance)} ZTC<br>
                        ‚Ä¢ Network: ZenChain Testnet<br><br>

                        <strong>Issues Found:</strong><br>
                        ${validationResults.filter(r => r.includes('‚ùå')).length === 0 ? 
                            '‚úÖ No issues detected' : 
                            'Contract functions may not be working properly'}
                    </div>
                `;
                updateStatus(html, '', 'analytics-output');

            } catch (error) {
                updateStatus('‚ùå Contract validation failed: ' + error.message, 'error', 'analytics-output');
            }
        }

        function exportErrorLogs() {
            try {
                const errorLog = {
                    timestamp: new Date().toISOString(),
                    network: 'ZenChain Testnet',
                    contractAddress: CONTRACT_ADDRESS,
                    rpcEndpoints: RPC_ENDPOINTS,
                    currentRpc: RPC_ENDPOINTS[currentRpcIndex],
                    walletConnected: walletConnected,
                    userAddress: userAddress,
                    issues: [
                        'Transaction failures on ZenChain testnet',
                        'RPC network performance issues',
                        'Gas estimation problems',
                        'Contract interaction failures'
                    ],
                    recommendations: [
                        'Use higher gas limits (500k+)',
                        'Implement retry logic',
                        'Try different RPC endpoints',
                        'Wait during off-peak hours'
                    ]
                };

                const blob = new Blob([JSON.stringify(errorLog, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `zenchain-error-log-${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                updateStatus('üìÅ Error log exported successfully!', 'success', 'analytics-output');

            } catch (error) {
                updateStatus('‚ùå Export failed: ' + error.message, 'error', 'analytics-output');
            }
        }

        //WALLET CONNECTION with better error handling
        async function connectWallet() {
            if (!window.ethereum) {
                showStatus('‚ùå Please install MetaMask!', 'error');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length === 0) return;

                const browserProvider = new ethers.BrowserProvider(window.ethereum);
                signer = await browserProvider.getSigner();
                userAddress = accounts[0];
                walletConnected = true;

                // Update contract with signer for admin functions
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                // Switch to ZenChain if needed
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: ZENCHAIN_CONFIG.chainIdHex }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [ZENCHAIN_CONFIG],
                        });
                    }
                }

                await updateWalletDisplay();
                await verifyOwnership();
                showStatus('‚úÖ Wallet connected successfully!', 'success');

            } catch (error) {
                console.error('‚ùå Wallet connection failed:', error);
                showStatus('‚ùå Failed to connect wallet: ' + error.message, 'error');
            }
        }

        async function disconnectWallet() {
            walletConnected = false;
            signer = null;
            userAddress = null;
            contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
            updateWalletDisplay();
            showStatus('üîå Wallet disconnected', 'info');
        }

        async function updateWalletDisplay() {
            const statusDot = document.getElementById('status-dot');
            const walletDisplay = document.getElementById('wallet-display');
            const balanceDisplay = document.getElementById('balance-display');
            const walletAction = document.getElementById('wallet-action');
            const walletActionText = document.getElementById('wallet-action-text');

            if (walletConnected && userAddress) {
                statusDot.classList.add('connected');
                walletDisplay.textContent = `${userAddress.substring(0, 8)}...${userAddress.substring(34)}`;

                try {
                    const balance = await provider.getBalance(userAddress);
                    balanceDisplay.textContent = `${parseFloat(ethers.formatEther(balance)).toFixed(4)} ZTC`;
                } catch (error) {
                    balanceDisplay.textContent = 'Balance error';
                }

                walletActionText.textContent = 'Disconnect';
                walletAction.onclick = disconnectWallet;
            } else {
                statusDot.classList.remove('connected');
                walletDisplay.textContent = 'Not Connected';
                balanceDisplay.textContent = 'Connect wallet';
                walletActionText.textContent = 'Connect Wallet';
                walletAction.onclick = connectWallet;
            }
        }

        async function verifyOwnership() {
            if (!walletConnected || !signer) {
                showStatus('‚ö†Ô∏è Connect wallet to verify ownership', 'warning', 'inventory-output');
                return false;
            }

            try {
                const owner = await contract.owner();
                const currentAddress = await signer.getAddress();
                const isOwner = owner.toLowerCase() === currentAddress.toLowerCase();

                if (isOwner) {
                    showStatus('üëë Verified: You are the contract owner!', 'success', 'inventory-output');
                    return true;
                } else {
                    showStatus('‚ö†Ô∏è Warning: You are not the contract owner', 'warning', 'inventory-output');
                    return false;
                }
            } catch (error) {
                showStatus('‚ùå Failed to verify ownership: ' + error.message, 'error', 'inventory-output');
                return false;
            }
        }

        // Purchase Monitoring Functions
        async function loadRecentPurchases() {
            try {
                updateStatus('üîÑ Loading recent purchases...', 'info', 'purchases-output');

                const latestBlock = await provider.getBlockNumber();
                const fromBlock = Math.max(latestBlock - 1000, 0);

                const filter = contract.filters.ProductPurchased();
                const events = await contract.queryFilter(filter, fromBlock, 'latest');

                displayPurchases(events, `Recent Purchases (Blocks ${fromBlock} - ${latestBlock})`);
                await updateAllStats();

            } catch (error) {
                console.error('‚ùå Error loading purchases:', error);
                updateStatus('‚ùå Error loading purchases: ' + error.message, 'error', 'purchases-output');

                // Show additional troubleshooting for purchase loading failures
                setTimeout(() => {
                    const troubleshootingHtml = `
                        <div class="status-message warning">
                            <strong>üîß Purchase Loading Failed</strong><br><br>
                            This is likely due to ZenChain RPC issues. Try:<br>
                            ‚Ä¢ Wait a few minutes and retry<br>
                            ‚Ä¢ Use "From Block" with recent block number<br>
                            ‚Ä¢ Check ZenTrace explorer manually<br>
                            ‚Ä¢ Switch to a different RPC endpoint
                        </div>
                    `;
                    document.getElementById('purchases-output').innerHTML += troubleshootingHtml;
                }, 2000);
            }
        }

        async function loadPurchasesFromBlock() {
            try {
                const blockNumber = prompt('Enter starting block number (recent blocks work better):', Math.max(currentBlockNumber - 100, 0));
                if (!blockNumber) return;

                updateStatus(`üîÑ Loading purchases from block ${blockNumber}...`, 'info', 'purchases-output');

                const filter = contract.filters.ProductPurchased();
                const events = await contract.queryFilter(filter, parseInt(blockNumber), 'latest');

                displayPurchases(events, `Purchases from Block ${blockNumber}`);

            } catch (error) {
                console.error('‚ùå Error loading purchases:', error);
                updateStatus('‚ùå Error: ' + error.message, 'error', 'purchases-output');
            }
        }

        function displayPurchases(events, title) {
            const output = document.getElementById('purchases-output');

            if (events.length === 0) {
                output.innerHTML = `
                    <div class="status-message warning">
                        <strong>${title}</strong><br>
                        No purchases found in this range.<br><br>
                        üí° This could mean:<br>
                        ‚Ä¢ No purchases have been made yet<br>
                        ‚Ä¢ Transactions are failing (check ZenTrace)<br>
                        ‚Ä¢ RPC sync issues with ZenChain<br>
                        ‚Ä¢ Contract events not being emitted properly<br><br>

                        üîó <a href="https://zentrace.io/address/${CONTRACT_ADDRESS}?tab=txs" target="_blank" class="tx-link">
                        Check ZenTrace for Failed Transactions</a>
                    </div>
                `;
                return;
            }

            let html = `<div class="status-message success"><strong>${title}</strong><br>Found ${events.length} successful purchases</div>`;

            events.reverse().forEach((event, index) => {
                const args = event.args;
                const isNew = index < 3;

                html += `
                    <div class="purchase-item ${isNew ? 'new' : ''}">
                        <div class="purchase-header">
                            Purchase #${args.purchaseId}
                        </div>
                        <div class="purchase-details">
                            <div class="detail-item">
                                <span class="detail-icon">üì¶</span>
                                Product: ${args.productId}
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon">üë§</span>
                                ${args.buyer.substring(0, 10)}...
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon">üìä</span>
                                Qty: ${args.quantity}
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon">üí∞</span>
                                ${ethers.formatEther(args.totalPrice)} ZTC
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon">üîó</span>
                                <a href="https://zentrace.io/tx/${event.transactionHash}" target="_blank" class="tx-link">
                                    ${event.transactionHash.substring(0, 10)}...
                                </a>
                            </div>
                            <div class="detail-item">
                                <span class="detail-icon">üìç</span>
                                Block: ${event.blockNumber}
                            </div>
                        </div>
                    </div>
                `;
            });

            output.innerHTML = html;
        }

        async function startLiveMonitoring() {
            const btn = document.getElementById('live-btn');

            if (isMonitoring) {
                contract.removeAllListeners("ProductPurchased");
                isMonitoring = false;
                btn.textContent = 'Start Live';
                btn.classList.remove('primary');
                updateStatus('‚ö´ Live monitoring stopped', 'info', 'purchases-output');
            } else {
                isMonitoring = true;
                btn.textContent = 'Stop Live';
                btn.classList.add('primary');
                updateStatus('üî¥ Live monitoring started - Note: ZenChain RPC may have delays...', 'success', 'purchases-output');

                contract.on("ProductPurchased", (purchaseId, productId, buyer, quantity, totalPrice, event) => {
                    console.log('üÜï New purchase detected!', event);

                    const output = document.getElementById('purchases-output');
                    const newPurchase = `
                        <div class="purchase-item new">
                            <div class="purchase-header">
                                üÜï LIVE: Purchase #${purchaseId}
                            </div>
                            <div class="purchase-details">
                                <div class="detail-item">
                                    <span class="detail-icon">üì¶</span>
                                    Product: ${productId}
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">üë§</span>
                                    ${buyer.substring(0, 10)}...
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">üìä</span>
                                    Qty: ${quantity}
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">üí∞</span>
                                    ${ethers.formatEther(totalPrice)} ZTC
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">üïê</span>
                                    ${new Date().toLocaleString()}
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">üîó</span>
                                    <a href="https://zentrace.io/tx/${event.log.transactionHash}" target="_blank" class="tx-link">
                                        ${event.log.transactionHash.substring(0, 10)}...
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;

                    output.insertAdjacentHTML('afterbegin', newPurchase);
                    updateAllStats();
                    showStatus(`üÜï New purchase: ${quantity}x Product #${productId}!`, 'success');
                });
            }
        }

        async function checkContractStatus() {
            try {
                const code = await provider.getCode(CONTRACT_ADDRESS);
                if (code === '0x') {
                    updateStatus('‚ùå Contract not found at this address!', 'error', 'purchases-output');
                    return;
                }

                const balance = await provider.getBalance(CONTRACT_ADDRESS);
                const block = await provider.getBlockNumber();

                const html = `
                    <div class="status-message success">
                        <strong>‚úÖ Contract Status: ACTIVE</strong><br><br>
                        üìç Address: ${CONTRACT_ADDRESS}<br>
                        üí∞ Contract Balance: ${ethers.formatEther(balance)} ZTC<br>
                        üìä Current Block: ${block}<br>
                        üîó Network: ZenChain Testnet (${ZENCHAIN_CONFIG.chainId})<br>
                        üìè Contract Size: ${(code.length / 2 - 1).toLocaleString()} bytes<br>
                        üåê RPC: ${RPC_ENDPOINTS[currentRpcIndex]}<br><br>

                        ‚ö†Ô∏è <strong>Known Issues:</strong><br>
                        ‚Ä¢ ZenChain RPC can be unstable<br>
                        ‚Ä¢ Transaction failures are common<br>
                        ‚Ä¢ Use higher gas limits for transactions<br><br>

                        üîó <a href="https://zentrace.io/address/${CONTRACT_ADDRESS}" target="_blank" class="tx-link">
                        View on ZenTrace Explorer</a>
                    </div>
                `;

                document.getElementById('purchases-output').innerHTML = html;

            } catch (error) {
                updateStatus('‚ùå Error checking contract: ' + error.message, 'error', 'purchases-output');
            }
        }

        // Financial Functions
        async function checkAdminBalance() {
            if (!walletConnected) {
                updateStatus('‚ö†Ô∏è Please connect wallet to check balance', 'warning', 'financial-output');
                return;
            }

            try {
                const balance = await provider.getBalance(userAddress);
                const contractBalance = await provider.getBalance(CONTRACT_ADDRESS);

                const html = `
                    <div class="status-message success">
                        <strong>üí∞ Financial Overview</strong><br><br>
                        üë§ Your Balance: ${ethers.formatEther(balance)} ZTC<br>
                        üè™ Contract Balance: ${ethers.formatEther(contractBalance)} ZTC<br>
                        üíé Available to Withdraw: ${ethers.formatEther(contractBalance)} ZTC<br><br>

                        ${parseFloat(ethers.formatEther(balance)) < 0.1 ? 
                            '‚ö†Ô∏è Low balance - get ZTC from faucet<br>' : ''}
                        ${parseFloat(ethers.formatEther(contractBalance)) > 0 ? 
                            '‚úÖ Funds available for withdrawal' : 
                            'üìù No funds to withdraw yet'}<br><br>

                        üîó <a href="https://faucet.zenchain.io" target="_blank" class="tx-link">
                        Get ZTC from Faucet</a>
                    </div>
                `;

                document.getElementById('financial-output').innerHTML = html;

            } catch (error) {
                updateStatus('‚ùå Error checking balance: ' + error.message, 'error', 'financial-output');
            }
        }

        async function checkContractBalance() {
            try {
                const balance = await provider.getBalance(CONTRACT_ADDRESS);
                const html = `
                    <div class="status-message info">
                        <strong>üè™ Contract Balance</strong><br><br>
                        üí∞ Current Balance: ${ethers.formatEther(balance)} ZTC<br>
                        üìä Balance in Wei: ${balance.toString()}<br><br>
                        ${parseFloat(ethers.formatEther(balance)) > 0 ? 
                            'üí° You can withdraw these funds if you are the owner' : 
                            'üìù No funds in contract yet - this is normal if no purchases succeeded'}
                    </div>
                `;

                document.getElementById('financial-output').innerHTML = html;
            } catch (error) {
                updateStatus('‚ùå Error checking contract balance: ' + error.message, 'error', 'financial-output');
            }
        }

        async function withdrawFunds() {
            if (!walletConnected) {
                updateStatus('‚ö†Ô∏è Please connect wallet to withdraw funds', 'warning', 'financial-output');
                return;
            }

            try {
                updateStatus('üîÑ Processing withdrawal...', 'info', 'financial-output');

                //higher gas limit for ZenChain
                const tx = await contract.withdrawZTC({
                    gasLimit: 500000,
                    gasPrice: ethers.parseUnits('100', 'gwei') // Fixed gas price
                });

                updateStatus('‚è≥ Waiting for confirmation (may take 2+ minutes on ZenChain)...', 'info', 'financial-output');

                const receipt = await tx.wait();

                const html = `
                    <div class="status-message success">
                        <strong>‚úÖ Withdrawal Successful!</strong><br><br>
                        üîó Transaction: <a href="https://zentrace.io/tx/${receipt.hash}" target="_blank" class="tx-link">${receipt.hash.substring(0, 20)}...</a><br>
                        ‚õΩ Gas Used: ${receipt.gasUsed}<br>
                        üìä Block: ${receipt.blockNumber}<br>
                        üí∞ Funds transferred to your wallet<br><br>
                        üéâ Check your wallet balance!
                    </div>
                `;

                document.getElementById('financial-output').innerHTML = html;

                // wallet display
                setTimeout(updateWalletDisplay, 3000);

            } catch (error) {
                console.error('‚ùå Withdrawal failed:', error);
                let errorMsg = error.message;

                if (error.message.includes('insufficient funds')) {
                    errorMsg = 'Insufficient funds for gas fees';
                } else if (error.message.includes('user rejected')) {
                    errorMsg = 'Transaction cancelled by user';
                } else if (error.message.includes('timeout')) {
                    errorMsg = 'Transaction timed out - may still be pending';
                }

                updateStatus('‚ùå Withdrawal failed: ' + errorMsg, 'error', 'financial-output');
            }
        }

        async function getNetworkInfo() {
            try {
                const network = await provider.getNetwork();
                const block = await provider.getBlockNumber();
                const gasPrice = await provider.getFeeData();

                const html = `
                    <div class="status-message info">
                        <strong>üåê Network Information</strong><br><br>
                        üîó Chain ID: ${network.chainId}<br>
                        üè∑Ô∏è Chain Name: ${network.name}<br>
                        üìä Latest Block: ${block}<br>
                        ‚õΩ Gas Price: ${gasPrice.gasPrice ? ethers.formatUnits(gasPrice.gasPrice, 'gwei') : 'N/A'} Gwei<br>
                        üöÄ RPC Status: ${RPC_ENDPOINTS[currentRpcIndex]} ‚úÖ<br><br>

                        <strong>ZenChain Testnet Info:</strong><br>
                        ‚Ä¢ Network can be unstable<br>
                        ‚Ä¢ High gas limits recommended<br>
                        ‚Ä¢ Transactions may take 2+ minutes<br>
                        ‚Ä¢ Use 50-100 Gwei gas price
                    </div>
                `;

                document.getElementById('financial-output').innerHTML = html;
            } catch (error) {
                updateStatus('‚ùå Error getting network info: ' + error.message, 'error', 'financial-output');
            }
        }

        // Inventory Management Functions
        async function viewAllProducts() {
            try {
                updateStatus('üîÑ Loading products...', 'info', 'inventory-output');

                const storeProducts = getStoreProducts();

                if (storeProducts && storeProducts.length > 0) {
                    displayProducts(storeProducts, 'Local Store Products');
                } else {
                    try {
                        const contractProducts = await contract.getActiveProducts();
                        displayProducts(contractProducts, 'Contract Products');
                    } catch (contractError) {
                        console.log('Contract products not available, using default set');
                        displayDefaultProducts();
                    }
                }

            } catch (error) {
                console.error('‚ùå Error loading products:', error);
                updateStatus('‚ùå Error loading products: ' + error.message, 'error', 'inventory-output');
            }
        }

        function getStoreProducts() {
            try {
                const products = localStorage.getItem('zenchain_products');
                return products ? JSON.parse(products) : null;
            } catch (error) {
                console.log('Could not access store products');
                return null;
            }
        }

        function displayProducts(products, title) {
            if (!products || products.length === 0) {
                updateStatus('‚ö†Ô∏è No products found', 'warning', 'inventory-output');
                return;
            }

            let html = `<div class="status-message success"><strong>üì¶ ${title} (${products.length})</strong></div>`;
            html += '<div class="product-grid">';

            products.forEach(product => {
                const stock = product.stock || 0;
                const stockClass = stock === 0 ? 'stock-out' : stock <= 5 ? 'stock-low' : '';
                const stockText = stock === 0 ? 'SOLD OUT' : stock <= 5 ? `Low: ${stock}` : `${stock}`;

                html += `
                    <div class="product-item">
                        <div class="product-header">
                            <span class="product-emoji">${product.image || 'üì¶'}</span>
                            <span class="product-id">ID: ${product.id}</span>
                        </div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-details">
                            <span class="product-price">${product.price} ZTC</span>
                            <span class="product-stock ${stockClass}">${stockText}</span>
                        </div>
                        <div class="product-actions">
                            <button class="product-btn" onclick="adjustStock(${product.id}, 1)">+1</button>
                            <button class="product-btn" onclick="adjustStock(${product.id}, -1)">-1</button>
                            <button class="product-btn danger" onclick="confirmDeleteProduct(${product.id})">Del</button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            document.getElementById('inventory-output').innerHTML = html;

            updateProductStats(products);
        }

        function displayDefaultProducts() {
            const defaultProducts = [
                { id: 1, name: 'ZenChain Gift Card - 10 ZTC', price: '10', image: 'üí≥', stock: 100 },
                { id: 2, name: 'ZenChain Gift Card - 25 ZTC', price: '25', image: 'üíé', stock: 50 },
                { id: 5, name: 'ZenChain Genesis NFT', price: '50', image: 'üñºÔ∏è', stock: 10 },
                { id: 7, name: 'Gaming Mouse RGB Pro', price: '45', image: 'üñ±Ô∏è', stock: 15 },
                { id: 11, name: 'Hardware Wallet', price: '120', image: 'üîê', stock: 8 }
            ];

            displayProducts(defaultProducts, 'Default Products (Demo)');
        }

        function adjustStock(productId, adjustment) {
            try {
                const products = getStoreProducts();
                if (!products) {
                    showStatus('‚ùå Cannot access store products', 'error');
                    return;
                }

                const product = products.find(p => p.id === productId);
                if (!product) {
                    showStatus('‚ùå Product not found', 'error');
                    return;
                }

                const newStock = Math.max(0, product.stock + adjustment);
                product.stock = newStock;

                localStorage.setItem('zenchain_products', JSON.stringify(products));
                viewAllProducts(); // Refresh display

                const action = adjustment > 0 ? 'increased' : 'decreased';
                showStatus(`‚úÖ Stock ${action}: ${product.name} now has ${newStock} units`, 'success');

            } catch (error) {
                console.error('‚ùå Error adjusting stock:', error);
                showStatus('‚ùå Error adjusting stock: ' + error.message, 'error');
            }
        }

        function confirmDeleteProduct(productId) {
            const product = getStoreProducts()?.find(p => p.id === productId);
            if (!product) {
                showStatus('‚ùå Product not found', 'error');
                return;
            }

            if (confirm(`Are you sure you want to delete "${product.name}"?\n\nThis cannot be undone and may cause issues if customers try to purchase this product.`)) {
                deleteProduct(productId);
            }
        }

        function deleteProduct(productId) {
            try {
                const products = getStoreProducts();
                if (!products) {
                    showStatus('‚ùå Cannot access store products', 'error');
                    return;
                }

                const productIndex = products.findIndex(p => p.id === productId);
                if (productIndex === -1) {
                    showStatus('‚ùå Product not found', 'error');
                    return;
                }

                const deletedProduct = products.splice(productIndex, 1)[0];
                localStorage.setItem('zenchain_products', JSON.stringify(products));

                viewAllProducts(); // Refresh display
                showStatus(`üóëÔ∏è Deleted product: ${deletedProduct.name}`, 'success');

            } catch (error) {
                console.error('‚ùå Error deleting product:', error);
                showStatus('‚ùå Error deleting product: ' + error.message, 'error');
            }
        }

        function showAddProductModal() {
            document.getElementById('add-product-modal').classList.add('show');
        }

        function showStockManager() {
            const modal = document.getElementById('stock-modal');
            const content = document.getElementById('stock-manager-content');

            const products = getStoreProducts();
            if (!products) {
                content.innerHTML = '<div class="status-message error">Cannot access store products</div>';
                modal.classList.add('show');
                return;
            }

            let html = '<div class="product-grid">';
            products.forEach(product => {
                const stockClass = product.stock === 0 ? 'stock-out' : product.stock <= 5 ? 'stock-low' : '';

                html += `
                    <div class="product-item">
                        <div class="product-header">
                            <span class="product-emoji">${product.image || 'üì¶'}</span>
                            <span class="product-id">${product.name}</span>
                        </div>
                        <div class="product-details">
                            <span class="product-stock ${stockClass}">Stock: ${product.stock}</span>
                        </div>
                        <div class="product-actions">
                            <button class="product-btn" onclick="adjustStock(${product.id}, 5); showStockManager();">+5</button>
                            <button class="product-btn" onclick="adjustStock(${product.id}, 10); showStockManager();">+10</button>
                            <button class="product-btn" onclick="adjustStock(${product.id}, -5); showStockManager();">-5</button>
                            <button class="product-btn" onclick="setCustomStock(${product.id})">Set</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            content.innerHTML = html;
            modal.classList.add('show');
        }

        function setCustomStock(productId) {
            const newStock = prompt('Enter new stock amount:');
            if (newStock === null || newStock === '') return;

            const stockNumber = parseInt(newStock);
            if (isNaN(stockNumber) || stockNumber < 0) {
                showStatus('‚ùå Invalid stock amount', 'error');
                return;
            }

            try {
                const products = getStoreProducts();
                const product = products.find(p => p.id === productId);
                if (product) {
                    product.stock = stockNumber;
                    localStorage.setItem('zenchain_products', JSON.stringify(products));
                    showStockManager(); // Refresh modal
                    showStatus(`‚úÖ Set stock for ${product.name} to ${stockNumber}`, 'success');
                }
            } catch (error) {
                showStatus('‚ùå Error setting stock: ' + error.message, 'error');
            }
        }

        function showDeleteProductModal() {
            const modal = document.getElementById('delete-product-modal');
            const content = document.getElementById('delete-manager-content');

            const products = getStoreProducts();
            if (!products) {
                content.innerHTML = '<div class="status-message error">Cannot access store products</div>';
                modal.classList.add('show');
                return;
            }

            let html = '<div style="margin-bottom: 1rem;"><strong>‚ö†Ô∏è Select products to delete (PERMANENT):</strong></div>';
            html += '<div class="product-grid">';

            products.forEach(product => {
                html += `
                    <div class="product-item">
                        <div class="product-header">
                            <span class="product-emoji">${product.image || 'üì¶'}</span>
                            <span class="product-id">ID: ${product.id}</span>
                        </div>
                        <div class="product-name" style="font-size: 0.8rem;">${product.name}</div>
                        <div class="product-details">
                            <span>${product.price} ZTC</span>
                            <span>Stock: ${product.stock}</span>
                        </div>
                        <div class="product-actions">
                            <button class="product-btn danger" onclick="confirmDeleteProduct(${product.id}); closeModal('delete-product-modal')">
                                DELETE
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            content.innerHTML = html;
            modal.classList.add('show');
        }

        // Add Product Form Handler
        document.getElementById('add-product-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = {
                name: document.getElementById('product-name').value,
                price: document.getElementById('product-price').value,
                stock: parseInt(document.getElementById('product-stock').value),
                category: document.getElementById('product-category').value,
                image: document.getElementById('product-emoji').value || 'üì¶',
                description: document.getElementById('product-description').value,
                delivery: document.getElementById('product-delivery').value,
                badge: document.getElementById('product-badge').value
            };

            try {
                const products = getStoreProducts() || [];
                const newId = Math.max(0, ...products.map(p => p.id)) + 1;

                const newProduct = {
                    id: newId,
                    ...formData
                };

                products.push(newProduct);
                localStorage.setItem('zenchain_products', JSON.stringify(products));

                closeModal('add-product-modal');
                this.reset();
                viewAllProducts();
                showStatus(`‚úÖ Added new product: ${formData.name}`, 'success');

            } catch (error) {
                console.error('‚ùå Error adding product:', error);
                showStatus('‚ùå Error adding product: ' + error.message, 'error');
            }
        });

        // Statistics Updates
        async function updateAllStats() {
            try {
                // Update purchase stats
                const filter = contract.filters.ProductPurchased();
                const events = await contract.queryFilter(filter, 0, 'latest');

                let totalRevenue = 0;
                let uniqueCustomers = new Set();

                events.forEach(event => {
                    totalRevenue += parseFloat(ethers.formatEther(event.args.totalPrice));
                    uniqueCustomers.add(event.args.buyer);
                });

                document.getElementById('total-purchases').textContent = events.length;
                document.getElementById('total-revenue').textContent = totalRevenue.toFixed(2);
                document.getElementById('unique-customers').textContent = uniqueCustomers.size;

                // Update product stats
                const products = getStoreProducts() || [];
                updateProductStats(products);

            } catch (error) {
                console.log('Could not update all stats:', error.message);
                // Set default values if stats can't be loaded
                document.getElementById('total-purchases').textContent = '-';
                document.getElementById('total-revenue').textContent = '-';
                document.getElementById('unique-customers').textContent = '-';
            }
        }

        function updateProductStats(products) {
            const totalProducts = products.length;
            const lowStockCount = products.filter(p => p.stock <= 5 && p.stock > 0).length;

            document.getElementById('total-products').textContent = totalProducts;
            document.getElementById('low-stock-count').textContent = lowStockCount;
        }

        // Utility Functions
        function updateStatus(message, type, outputId = 'purchases-output') {
            const output = document.getElementById(outputId);
            if (!output) return;

            if (type) {
                output.innerHTML = `<div class="status-message ${type}">${message}</div>`;
            } else {
                output.innerHTML = message;
            }
        }

        function showStatus(message, type = 'info', duration = 4000) {
            console.log(`[${type.toUpperCase()}] ${message}`);

            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--success-green)' : 
                           type === 'error' ? 'var(--error-red)' : 
                           type === 'warning' ? 'var(--warning-orange)' : 'var(--info-blue)'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 9999;
                max-width: 350px;
                font-weight: 500;
                transform: translateX(400px);
                transition: transform 0.3s ease-in-out;
            `;

            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => { toast.style.transform = 'translateX(0)'; }, 100);

            setTimeout(() => {
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // Modal Management
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Event Listeners
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

        // Initialize on load
        window.addEventListener('load', init);

        console.log('‚úÖ ZenChain Admin Dashboard');
    </script>
</body>
</html>